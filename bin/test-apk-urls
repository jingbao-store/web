#!/usr/bin/env ruby
# frozen_string_literal: true

# æµ‹è¯• APK æ–‡ä»¶ URL ç”Ÿæˆæ˜¯å¦æ­£ç¡®
# ä½¿ç”¨æ–¹æ³•: RAILS_ENV=production bin/test-apk-urls

require_relative '../config/environment'

puts "=" * 80
puts "APK URL é…ç½®æµ‹è¯•"
puts "=" * 80
puts

# 1. æ£€æŸ¥ç¯å¢ƒé…ç½®
puts "ğŸ“‹ 1. æ£€æŸ¥ç¯å¢ƒé…ç½®"
puts "-" * 40

url_options = Rails.application.routes.default_url_options
puts "Host: #{url_options[:host]}"
puts "Port: #{url_options[:port]}"
puts "Protocol: #{url_options[:protocol]}"
puts

expected_host = ENV['PUBLIC_HOST'] || 'localhost'
if url_options[:host] == expected_host
  puts "âœ… Host é…ç½®æ­£ç¡®"
else
  puts "âŒ Host é…ç½®é”™è¯¯ï¼"
  puts "   é¢„æœŸ: #{expected_host}"
  puts "   å®é™…: #{url_options[:host]}"
end
puts

# 2. æ£€æŸ¥æœ‰ APK æ–‡ä»¶çš„åº”ç”¨
puts "ğŸ“‹ 2. æ£€æŸ¥å·²ä¸Šä¼  APK çš„åº”ç”¨"
puts "-" * 40

apps_with_apk = Application.joins(:apk_file_attachment).distinct
puts "æ‰¾åˆ° #{apps_with_apk.count} ä¸ªå·²ä¸Šä¼  APK çš„åº”ç”¨"
puts

if apps_with_apk.empty?
  puts "âš ï¸  æ²¡æœ‰æ‰¾åˆ°å·²ä¸Šä¼  APK çš„åº”ç”¨"
  puts "   è¯·å…ˆåœ¨åå°ä¸Šä¼  APK æ–‡ä»¶"
  exit
end

# 3. æµ‹è¯• URL ç”Ÿæˆ
puts "ğŸ“‹ 3. æµ‹è¯• URL ç”Ÿæˆ"
puts "-" * 40

apps_with_apk.limit(5).each do |app|
  puts "\nåº”ç”¨: #{app.name} (ID: #{app.id})"
  puts "  Package: #{app.package_name}"
  
  if app.apk_file.attached?
    puts "  âœ… APK å·²é™„åŠ "
    puts "  æ–‡ä»¶å: #{app.apk_file.filename}"
    puts "  å¤§å°: #{number_to_human_size(app.apk_file.byte_size)}"
    
    begin
      download_url = app.final_download_url
      
      if download_url.nil?
        puts "  âŒ download_url ä¸º nil"
      elsif download_url.start_with?('http://localhost') || download_url.include?(':3000')
        puts "  âš ï¸  URL ä½¿ç”¨ localhost (å¯èƒ½ä¸æ­£ç¡®)"
        puts "     URL: #{download_url}"
      elsif download_url.start_with?("https://#{expected_host}")
        puts "  âœ… URL ç”Ÿæˆæ­£ç¡®"
        puts "     URL: #{download_url}"
      else
        puts "  âš ï¸  URL ä¸»æœºä¸åŒ¹é…"
        puts "     URL: #{download_url}"
      end
    rescue => e
      puts "  âŒ ç”Ÿæˆ URL æ—¶å‡ºé”™: #{e.message}"
      puts "     #{e.backtrace.first}"
    end
  else
    puts "  âŒ APK æœªé™„åŠ "
  end
end

puts
puts

# 4. æµ‹è¯• API å“åº”
puts "ğŸ“‹ 4. æµ‹è¯• API å“åº”"
puts "-" * 40

if apps_with_apk.any?
  app = apps_with_apk.first
  puts "\næµ‹è¯•åº”ç”¨: #{app.name} (ID: #{app.id})"
  
  # æ¨¡æ‹Ÿ API å“åº”
  data = app.as_json(
    only: [:id, :name, :package_name, :version, :file_size],
    methods: []
  )
  data['download_url'] = app.final_download_url
  
  puts "\nAPI å“åº”ç¤ºä¾‹:"
  puts JSON.pretty_generate(data)
end

puts
puts

# 5. è¯Šæ–­å»ºè®®
puts "ğŸ“‹ 5. è¯Šæ–­å»ºè®®"
puts "-" * 40
puts

issues = []

if url_options[:host] == 'localhost'
  issues << "éœ€è¦è®¾ç½® PUBLIC_HOST ç¯å¢ƒå˜é‡"
end

if apps_with_apk.empty?
  issues << "æ²¡æœ‰å·²ä¸Šä¼  APK çš„åº”ç”¨"
end

if issues.empty?
  puts "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
  puts
  puts "å¦‚æœ API ä»ç„¶è¿”å›é”™è¯¯çš„ URLï¼Œè¯·å°è¯•ï¼š"
  puts "1. é‡å¯ Rails åº”ç”¨"
  puts "2. æ¸…é™¤ç¼“å­˜: rails cache:clear"
  puts "3. æ£€æŸ¥ Nginx/Apache é…ç½®"
else
  puts "âŒ å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š"
  issues.each_with_index do |issue, index|
    puts "#{index + 1}. #{issue}"
  end
  puts
  puts "ä¿®å¤å»ºè®®ï¼š"
  if url_options[:host] == 'localhost'
    puts "â€¢ åœ¨ç”Ÿäº§ç¯å¢ƒè®¾ç½®: export PUBLIC_HOST=jingbao.store"
    puts "â€¢ ç„¶åé‡å¯ Rails åº”ç”¨"
  end
  if apps_with_apk.empty?
    puts "â€¢ ç™»å½•åå° /admin/applications"
    puts "â€¢ ç¼–è¾‘åº”ç”¨å¹¶ä¸Šä¼  APK æ–‡ä»¶"
  end
end

puts
puts "=" * 80
puts "æµ‹è¯•å®Œæˆ"
puts "=" * 80

# Helper method
def number_to_human_size(bytes)
  return "0 B" if bytes.nil? || bytes == 0
  
  units = ['B', 'KB', 'MB', 'GB', 'TB']
  exponent = (Math.log(bytes) / Math.log(1024)).floor
  exponent = [exponent, units.length - 1].min
  
  size = bytes.to_f / (1024 ** exponent)
  
  if size >= 100
    "#{size.round(0).to_i} #{units[exponent]}"
  elsif size >= 10
    "#{size.round(1)} #{units[exponent]}"
  else
    "#{size.round(2)} #{units[exponent]}"
  end
end

